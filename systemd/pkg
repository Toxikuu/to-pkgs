#!/to

n="systemd"
v="257.5"
a="System and service manager"
m="Tox"
l=(
    "CC0-1.0"
    "GPL-2.0-or-later"
    "LGPL-2.1-or-later"
    "MIT-0"
)
t="core utils cli lib"
u="https://github.com/$n/$n.git"

s=(
    "${u%.git}/archive/v$v/$n-$v.tar.gz"
)

d=(
    "b,meson"
    "b,ninja"

    # polkit recommended at runtime; circular
    # "r,polkit"

    "acl"
    "binutils"
    "coreutils"
    "diffutils"
    "gawk"
    "glibc"
    "gperf"
    "grep"
    "hwdata"
    "jinja2"
    "kmod"
    "libcap"
    "libelf"
    "libidn2"
    "libseccomp"
    "libxcrypt"
    "linux-pam"
    "openssl"
    "pcre2"
    "sed"
    "xz"
    "zlib"
    "zstd"
)

b() {

with mn

# Remove unneeded groups from the default udev rules
sed -e 's/GROUP="render"/GROUP="video"/' \
    -e 's/GROUP="sgx", //'               \
    -i rules.d/50-udev-default.rules.in

_cfg=(
    -D default-dnssec=no
    -D firstboot=false
    -D install-tests=false
    -D ldconfig=false
    -D sysusers=false
    -D rpmmacrosdir=no
    -D homed=disabled
    -D userdb=false
    -D man=auto
    -D mode=release
    -D pamconfdir=/etc/pam.d
    -D dev-kvm-mode=0660
    -D nobody-group=nogroup
    -D sysupdate=disabled
    -D ukify=disabled
)

ms
nj
ni

install -vDm644 "$A/systemd-user" -t "$D/etc/pam.d/"

}

posti() {

# Some post-install setup
systemd-machine-id-setup
systemctl preset-all

# Add systemd stuff to /etc/pam.d/system-session
grep 'pam_systemd' /etc/pam.d/system-session ||
cat >> /etc/pam.d/system-session << "EOF"

# Additional systemd stuff
session  required    pam_loginuid.so
session  optional    pam_systemd.so
EOF

# Replace the running systemd manager with the newly installed one
systemctl daemon-reexec

}

t() {

# Several failures are expected
ninja test || true

}
